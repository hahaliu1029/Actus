# 后端 项目架构文档

## 1. 技术栈

| 类别 | 技术 | 说明 |
|------|------|------|
| **Web 框架** | FastAPI + Uvicorn | 异步 ASGI 框架 |
| **数据验证** | Pydantic v2 | 请求/响应模型 & 配置管理 |
| **数据库** | PostgreSQL + SQLAlchemy 2.0 (async) | 异步 ORM，asyncpg 驱动 |
| **数据库迁移** | Alembic | 版本化 schema 迁移 |
| **缓存/消息队列** | Redis (Redis Streams) | 任务队列 & 事件流 |
| **对象存储** | MinIO (S3 兼容) | 文件上传/下载 |
| **认证** | JWT (python-jose) + bcrypt (passlib) | Bearer Token 认证 |
| **LLM** | OpenAI SDK (对接 DeepSeek 等) | 大语言模型调用 |
| **Agent 协议** | MCP SDK + A2A | 工具协议 & 智能体间通信 |
| **浏览器自动化** | Playwright (CDP) + DOM 索引提取 | 实时提取可交互元素，通过索引/选择器精确操作，支持截图 |
| **沙箱** | Docker | 隔离代码执行环境 |
| **搜索** | Bing Search API | 网络搜索能力 |
| **测试** | pytest | 单元测试 & 集成测试 |

## 2. 架构分层

项目采用 **整洁架构 (Clean Architecture)** + **领域驱动设计 (DDD)**，严格遵循依赖规则：外层依赖内层，内层不依赖外层。

```
┌─────────────────────────────────────────────────────┐
│                  Interfaces 接口层                     │
│         (FastAPI Routes / Schemas / Auth)             │
├─────────────────────────────────────────────────────┤
│                Application 应用层                      │
│            (Service 用例编排 / Exceptions)              │
├─────────────────────────────────────────────────────┤
│                  Domain 领域层                         │
│    (Models / Repository接口 / External接口 /           │
│     Agents / Flows / Tools / Prompts)                │
├─────────────────────────────────────────────────────┤
│              Infrastructure 基础设施层                  │
│   (ORM Models / DB Repos / Storage Clients /         │
│    External Impls / Logging)                         │
├─────────────────────────────────────────────────────┤
│                    Core 核心层                         │
│            (Config / Security / JWT)                  │
└─────────────────────────────────────────────────────┘
```

### 依赖方向

```
Interfaces → Application → Domain ← Infrastructure
                             ↑
                            Core
```

- **Domain 层**定义抽象接口 (ABC)，**Infrastructure 层**提供具体实现
- 通过 FastAPI `Depends()` 实现依赖注入，在 `service_dependencies.py` 和 `repository_dependencies.py` 中组装

### 各层职责

| 层 | 目录 | 职责 | 允许的依赖 |
|----|------|------|-----------|
| **Core** | `core/` | 配置管理、JWT/密码工具 | 无 |
| **Domain** | `app/domain/` | 领域模型、仓库接口 (ABC)、外部服务接口 (ABC)、领域服务 | Core |
| **Application** | `app/application/` | 用例编排、业务异常定义 | Domain, Core |
| **Infrastructure** | `app/infrastructure/` | ORM 模型、仓库实现、存储客户端、外部服务实现 | Domain, Core |
| **Interfaces** | `app/interfaces/` | 路由、Schema、认证依赖、异常处理器、依赖注入组装 | Application, Domain, Infrastructure, Core |

## 3. 目录结构

```
api/
├── core/                                    # 核心配置层
│   ├── config.py                           #   Pydantic Settings 配置管理
│   └── security.py                         #   JWT 令牌 & 密码哈希工具
│
├── app/
│   ├── main.py                             # 应用入口 (FastAPI 实例 & 生命周期)
│   │
│   ├── domain/                             # 领域层
│   │   ├── models/                         #   领域模型 (Pydantic BaseModel)
│   │   ├── repositories/                   #   仓库接口 (ABC 抽象基类)
│   │   ├── external/                       #   外部服务接口 (ABC 抽象基类)
│   │   └── services/                       #   领域服务
│   │       ├── agents/                     #     智能体 (BaseAgent / Planner / ReAct)
│   │       ├── flows/                      #     编排流程 (BaseFlow / PlannerReActFlow)
│   │       ├── tools/                      #     工具集 (BaseTool + @tool 装饰器)
│   │       └── prompts/                    #     Prompt 模板 (中文 + 英文)
│   │
│   ├── application/                        # 应用层
│   │   ├── services/                       #   应用服务 (用例编排)
│   │   └── errors/
│   │       └── exceptions.py               #   业务异常定义
│   │
│   ├── infrastructure/                     # 基础设施层
│   │   ├── models/                         #   ORM 模型 (SQLAlchemy)
│   │   ├── repositories/                   #   仓库实现 (数据库操作)
│   │   ├── storage/                        #   存储客户端 (PostgreSQL / Redis / MinIO)
│   │   ├── external/                       #   外部服务实现 (LLM / Browser / Sandbox / ...)
│   │   └── logging/                        #   日志配置
│   │
│   └── interfaces/                         # 接口层
│       ├── endpoints/                      #   路由处理器
│       ├── schemas/                        #   请求/响应 Schema
│       ├── dependencies/                   #   认证依赖
│       ├── errors/                         #   全局异常处理器
│       ├── repository_dependencies.py      #   仓库依赖注入
│       └── service_dependencies.py         #   服务依赖注入
│
├── alembic/                                # 数据库迁移
├── scripts/                                # 运维脚本
├── tests/                                  # 测试
├── config.yaml                             # 运行时配置 (LLM/MCP/A2A)
├── alembic.ini                             # Alembic 配置
├── pytest.ini                              # pytest 配置
├── run.sh                                  # 生产启动脚本
└── dev.sh                                  # 开发启动脚本
```

## 4. 依赖注入

通过 FastAPI `Depends()` 实现 IoC，逐层组装：

```
Endpoint (接口层)
    ↓ Depends()
service_dependencies.py  →  Application Service
    ↓ Depends()
repository_dependencies.py  →  Infrastructure Repository
    ↓ Depends()
Storage Clients (postgres / redis / minio)
```

## 5. 编码约束

### 5.1 分层规则

- **Domain 层禁止依赖任何框架**（不导入 FastAPI / SQLAlchemy / Redis 等），只使用 Python 标准库 + Pydantic
- **Domain 层通过 ABC 定义接口**，所有仓库 (`repositories/`) 和外部服务 (`external/`) 均为抽象基类
- **Infrastructure 层实现 Domain 层接口**，命名规则：`DB{Name}Repository`（数据库仓库）、`{Provider}{Name}`（外部服务，如 `MinioFileStorage`、`PlaywrightBrowser`）
- **Application 层只做编排**，不包含基础设施细节，通过构造函数注入依赖
- **Interfaces 层负责组装**，在 `service_dependencies.py` / `repository_dependencies.py` 中完成依赖注入接线

### 5.2 模型规范

- **领域模型**使用 `Pydantic BaseModel`，放在 `domain/models/`
- **ORM 模型**使用 `SQLAlchemy DeclarativeBase`，放在 `infrastructure/models/`
- **请求/响应 Schema**使用 `Pydantic BaseModel`，放在 `interfaces/schemas/`
- 三类模型严格分离，不混用

### 5.3 API 规范

- 所有路由统一前缀 `/api`，在 `endpoints/routes.py` 中集中注册
- 每个路由模块独立文件，使用 `APIRouter` + tag 分组
- 统一响应包装 `Response[T]`，格式：`{ "code": int, "msg": str, "data": T }`
- 认证路由通过 `Depends(get_current_user)` 注入当前用户

### 5.4 异常处理规范

- 业务异常继承自 `AppException` 基类，定义在 `application/errors/exceptions.py`
- 预定义异常类型：`BadRequestError(400)` / `NotFoundError(404)` / `ForbiddenError(403)` / `ValidationError(422)` / `TooManyRequestsError(429)` / `ServerRequestsError(500)`
- 全局异常处理器在 `interfaces/errors/exception_handlers.py` 中注册，三级捕获：AppException → HTTPException → Exception 兜底
- 所有异常统一返回 `Response` 格式

### 5.5 工具系统规范

- 所有工具继承 `BaseTool`，通过 `@tool` 装饰器注册，自动生成 OpenAI Function Calling Schema
- 工具类必须设置 `name` 属性作为工具集名称
- 工具方法通过 `invoke(tool_name, **kwargs)` 统一调用，内部自动过滤 LLM 幻觉参数
- 新增工具只需：继承 `BaseTool` → 用 `@tool` 装饰方法 → 注入到 Flow 的 tools 列表

### 5.6 配置规范

- **环境配置**：`core/config.py` 使用 Pydantic Settings，支持 `.env` 覆盖，`@lru_cache()` 缓存
- **运行时配置**：`config.yaml` 存放 LLM / Agent / MCP / A2A 参数，通过 `FileAppConfigRepository` 读取
- 敏感信息（密钥、密码）通过环境变量注入，不硬编码

### 5.7 异步规范

- 全栈异步：FastAPI async endpoint → SQLAlchemy async session → asyncpg → Redis async
- 存储客户端在 `lifespan` 中统一初始化和销毁
- Agent 工具调用、LLM 调用均为 `async`，支持配置化重试（`max_retries` + `retry_interval`）

### 5.8 命名约定

| 类型 | 命名规则 | 示例 |
|------|----------|------|
| 领域模型 | 大驼峰 | `User`, `Session`, `Plan` |
| 仓库接口 | `{Name}Repository` | `SessionRepository` |
| 仓库实现 | `DB{Name}Repository` | `DBSessionRepository` |
| 外部服务接口 | 功能名 | `LLM`, `Browser`, `Sandbox` |
| 外部服务实现 | `{Provider}{Interface}` | `OpenAILLM`, `PlaywrightBrowser`, `DockerSandbox` |
| 应用服务 | `{Name}Service` | `AuthService`, `SessionService` |
| 路由文件 | `{name}_routes.py` | `auth_routes.py`, `session_routes.py` |
| Schema 文件 | `{name}.py` | `auth.py`, `session.py` |
| 工具类 | `{Name}Tool` | `ShellTool`, `BrowserTool`, `MCPTool` |
| Agent 类 | `{Name}Agent` | `PlannerAgent`, `ReActAgent` |
| Flow 类 | `{Name}Flow` | `PlannerReActFlow` |

### 5.9 数据库迁移

- 使用 Alembic 管理 schema 变更，迁移文件在 `alembic/versions/`
- ORM 模型变更后需生成对应迁移脚本
- 迁移文件命名包含描述：`{hash}_{description}.py`
