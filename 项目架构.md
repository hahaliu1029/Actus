# 后端 项目架构文档

## 1. 技术栈

| 类别 | 技术 | 说明 |
|------|------|------|
| **Web 框架** | FastAPI + Uvicorn | 异步 ASGI 框架 |
| **数据验证** | Pydantic v2 | 请求/响应模型 & 配置管理 |
| **数据库** | PostgreSQL + SQLAlchemy 2.0 (async) | 异步 ORM，asyncpg 驱动 |
| **数据库迁移** | Alembic | 版本化 schema 迁移 |
| **缓存/消息队列** | Redis (Redis Streams) | 任务队列 & 事件流 |
| **对象存储** | MinIO (S3 兼容) | 文件上传/下载 |
| **认证** | JWT (python-jose) + bcrypt (passlib) | Bearer Token 认证 |
| **LLM** | OpenAI SDK (对接 DeepSeek 等) | 大语言模型调用 |
| **Agent 协议** | MCP SDK + A2A | 工具协议 & 智能体间通信 |
| **浏览器自动化** | Playwright (CDP) + DOM 索引提取 | 实时提取可交互元素，通过索引/选择器精确操作，支持截图 |
| **沙箱** | Docker | 隔离代码执行环境 |
| **搜索** | Bing Search API | 网络搜索能力 |
| **测试** | pytest | 单元测试 & 集成测试 |

## 2. 架构分层

项目采用 **整洁架构 (Clean Architecture)** + **领域驱动设计 (DDD)**，严格遵循依赖规则：外层依赖内层，内层不依赖外层。

```
┌─────────────────────────────────────────────────────┐
│                  Interfaces 接口层                     │
│         (FastAPI Routes / Schemas / Auth)             │
├─────────────────────────────────────────────────────┤
│                Application 应用层                      │
│            (Service 用例编排 / Exceptions)              │
├─────────────────────────────────────────────────────┤
│                  Domain 领域层                         │
│    (Models / Repository接口 / External接口 /           │
│     Agents / Flows / Tools / Prompts)                │
├─────────────────────────────────────────────────────┤
│              Infrastructure 基础设施层                  │
│   (ORM Models / DB Repos / Storage Clients /         │
│    External Impls / Logging)                         │
├─────────────────────────────────────────────────────┤
│                    Core 核心层                         │
│            (Config / Security / JWT)                  │
└─────────────────────────────────────────────────────┘
```

### 依赖方向

```
Interfaces → Application → Domain ← Infrastructure
                             ↑
                            Core
```

- **Domain 层**定义抽象接口 (ABC)，**Infrastructure 层**提供具体实现
- 通过 FastAPI `Depends()` 实现依赖注入，在 `service_dependencies.py` 和 `repository_dependencies.py` 中组装

### 各层职责

| 层 | 目录 | 职责 | 允许的依赖 |
|----|------|------|-----------|
| **Core** | `core/` | 配置管理、JWT/密码工具 | 无 |
| **Domain** | `app/domain/` | 领域模型、仓库接口 (ABC)、外部服务接口 (ABC)、领域服务 | Core |
| **Application** | `app/application/` | 用例编排、业务异常定义 | Domain, Core |
| **Infrastructure** | `app/infrastructure/` | ORM 模型、仓库实现、存储客户端、外部服务实现 | Domain, Core |
| **Interfaces** | `app/interfaces/` | 路由、Schema、认证依赖、异常处理器、依赖注入组装 | Application, Domain, Infrastructure, Core |

## 3. 目录结构

```
api/
├── core/                                    # 核心配置层
│   ├── config.py                           #   Pydantic Settings 配置管理
│   └── security.py                         #   JWT 令牌 & 密码哈希工具
│
├── app/
│   ├── main.py                             # 应用入口 (FastAPI 实例 & 生命周期)
│   │
│   ├── domain/                             # 领域层
│   │   ├── models/                         #   领域模型 (Pydantic BaseModel)
│   │   │   └── skill.py                    #   Skill 领域模型、枚举、辅助函数
│   │   ├── repositories/                   #   仓库接口 (ABC 抽象基类)
│   │   │   └── skill_repository.py         #   Skill 仓库接口
│   │   ├── external/                       #   外部服务接口 (ABC 抽象基类)
│   │   └── services/                       #   领域服务
│   │       ├── agents/                     #     智能体 (BaseAgent / Planner / ReAct)
│   │       ├── flows/                      #     编排流程 (BaseFlow / PlannerReActFlow)
│   │       ├── tools/                      #     工具集 (BaseTool + @tool 装饰器)
│   │       │   └── skill.py                #     SkillTool 统一工具层 (native/mcp/a2a)
│   │       └── prompts/                    #     Prompt 模板 (中文 + 英文)
│   │
│   ├── application/                        # 应用层
│   │   ├── services/                       #   应用服务 (用例编排)
│   │   │   ├── skill_service.py            #   Skill 安装/管理服务
│   │   │   ├── skill_source_loader.py      #   Skill 来源加载器 (GitHub / 本地)
│   │   │   ├── skill_selector.py           #   Skill 渐进式选择器 (关键词评分)
│   │   │   └── skill_index_service.py      #   Skill 索引缓存服务 (基于 mtime)
│   │   └── errors/
│   │       └── exceptions.py               #   业务异常定义
│   │
│   ├── infrastructure/                     # 基础设施层
│   │   ├── models/                         #   ORM 模型 (SQLAlchemy)
│   │   ├── repositories/                   #   仓库实现 (数据库/文件系统操作)
│   │   │   ├── file_skill_repository.py    #   Skill 文件系统仓库 (当前使用)
│   │   │   └── db_skill_repository.py      #   Skill 数据库仓库 (已废弃，保留用于回滚)
│   │   ├── storage/                        #   存储客户端 (PostgreSQL / Redis / MinIO)
│   │   ├── external/                       #   外部服务实现 (LLM / Browser / Sandbox / ...)
│   │   └── logging/                        #   日志配置
│   │
│   └── interfaces/                         # 接口层
│       ├── endpoints/                      #   路由处理器
│       ├── schemas/                        #   请求/响应 Schema
│       ├── dependencies/                   #   认证依赖
│       ├── errors/                         #   全局异常处理器
│       ├── repository_dependencies.py      #   仓库依赖注入
│       └── service_dependencies.py         #   服务依赖注入
│
├── alembic/                                # 数据库迁移
├── scripts/                                # 运维脚本
├── tests/                                  # 测试
├── config.yaml                             # 运行时配置 (LLM/MCP/A2A)
├── alembic.ini                             # Alembic 配置
├── pytest.ini                              # pytest 配置
├── run.sh                                  # 生产启动脚本
└── dev.sh                                  # 开发启动脚本
```

## 4. 依赖注入

通过 FastAPI `Depends()` 实现 IoC，逐层组装：

```
Endpoint (接口层)
    ↓ Depends()
service_dependencies.py  →  Application Service
    ↓ Depends()
repository_dependencies.py  →  Infrastructure Repository
    ↓ Depends()
Storage Clients (postgres / redis / minio)
```

## 5. 编码约束

### 5.1 分层规则

- **Domain 层禁止依赖任何框架**（不导入 FastAPI / SQLAlchemy / Redis 等），只使用 Python 标准库 + Pydantic
- **Domain 层通过 ABC 定义接口**，所有仓库 (`repositories/`) 和外部服务 (`external/`) 均为抽象基类
- **Infrastructure 层实现 Domain 层接口**，命名规则：`DB{Name}Repository`（数据库仓库）、`File{Name}Repository`（文件系统仓库）、`{Provider}{Name}`（外部服务，如 `MinioFileStorage`、`PlaywrightBrowser`）
- **Application 层只做编排**，不包含基础设施细节，通过构造函数注入依赖
- **Interfaces 层负责组装**，在 `service_dependencies.py` / `repository_dependencies.py` 中完成依赖注入接线

### 5.2 模型规范

- **领域模型**使用 `Pydantic BaseModel`，放在 `domain/models/`
- **ORM 模型**使用 `SQLAlchemy DeclarativeBase`，放在 `infrastructure/models/`
- **请求/响应 Schema**使用 `Pydantic BaseModel`，放在 `interfaces/schemas/`
- 三类模型严格分离，不混用

### 5.3 API 规范

- 所有路由统一前缀 `/api`，在 `endpoints/routes.py` 中集中注册
- 每个路由模块独立文件，使用 `APIRouter` + tag 分组
- 统一响应包装 `Response[T]`，格式：`{ "code": int, "msg": str, "data": T }`
- 认证路由通过 `Depends(get_current_user)` 注入当前用户

### 5.4 异常处理规范

- 业务异常继承自 `AppException` 基类，定义在 `application/errors/exceptions.py`
- 预定义异常类型：`BadRequestError(400)` / `NotFoundError(404)` / `ForbiddenError(403)` / `ValidationError(422)` / `TooManyRequestsError(429)` / `ServerRequestsError(500)`
- 全局异常处理器在 `interfaces/errors/exception_handlers.py` 中注册，三级捕获：AppException → HTTPException → Exception 兜底
- 所有异常统一返回 `Response` 格式

### 5.5 工具系统规范

- 所有工具继承 `BaseTool`，通过 `@tool` 装饰器注册，自动生成 OpenAI Function Calling Schema
- 工具类必须设置 `name` 属性作为工具集名称
- 工具方法通过 `invoke(tool_name, **kwargs)` 统一调用，内部自动过滤 LLM 幻觉参数
- 新增工具只需：继承 `BaseTool` → 用 `@tool` 装饰方法 → 注入到 Flow 的 tools 列表

### 5.6 配置规范

- **环境配置**：`core/config.py` 使用 Pydantic Settings，支持 `.env` 覆盖，`@lru_cache()` 缓存
- **运行时配置**：`config.yaml` 存放 LLM / Agent / MCP / A2A 参数，通过 `FileAppConfigRepository` 读取
- 敏感信息（密钥、密码）通过环境变量注入，不硬编码

### 5.7 异步规范

- 全栈异步：FastAPI async endpoint → SQLAlchemy async session → asyncpg → Redis async
- 存储客户端在 `lifespan` 中统一初始化和销毁
- Agent 工具调用、LLM 调用均为 `async`，支持配置化重试（`max_retries` + `retry_interval`）

### 5.8 命名约定

| 类型 | 命名规则 | 示例 |
|------|----------|------|
| 领域模型 | 大驼峰 | `User`, `Session`, `Plan` |
| 仓库接口 | `{Name}Repository` | `SessionRepository` |
| 仓库实现 | `DB{Name}Repository` / `File{Name}Repository` | `DBSessionRepository`, `FileSkillRepository` |
| 外部服务接口 | 功能名 | `LLM`, `Browser`, `Sandbox` |
| 外部服务实现 | `{Provider}{Interface}` | `OpenAILLM`, `PlaywrightBrowser`, `DockerSandbox` |
| 应用服务 | `{Name}Service` | `AuthService`, `SessionService` |
| 路由文件 | `{name}_routes.py` | `auth_routes.py`, `session_routes.py` |
| Schema 文件 | `{name}.py` | `auth.py`, `session.py` |
| 工具类 | `{Name}Tool` | `ShellTool`, `BrowserTool`, `MCPTool`, `SkillTool` |
| Agent 类 | `{Name}Agent` | `PlannerAgent`, `ReActAgent` |
| Flow 类 | `{Name}Flow` | `PlannerReActFlow` |

### 5.9 数据库迁移

- 使用 Alembic 管理 schema 变更，迁移文件在 `alembic/versions/`
- ORM 模型变更后需生成对应迁移脚本
- 迁移文件命名包含描述：`{hash}_{description}.py`

## 6. Skill 生态系统架构

### 6.1 整体架构

Skill 是独立的扩展生态层，通过 SKILL.md 定义与安装，以**文件系统**为权威存储，通过 `SkillTool` 适配后注入 Agent 工具集。

```
用户安装 Skill
    │
    ▼
skill_v2_routes.py (接口层)
    │  创建 SkillService + FileSkillRepository
    ▼
skill_service.py (应用层)
    ├── SkillSourceLoader.load() → GitHub / 本地目录 bundle 加载
    ├── _normalize_manifest_input() → SKILL.md frontmatter 解析或 manifest 透传
    ├── _validate_native_command_policy() → 安全策略校验
    └── _build_context_blob() → 上下文摘要构建
    ▼
file_skill_repository.py (基础设施层)
    │  读写 {skills_root}/{skill_id}/(meta.json + manifest.json + SKILL.md + bundle/)
    ▼
文件系统 /app/data/skills/

Agent 运行时:
    SkillIndexService → 缓存已启用 Skill（基于目录 mtime 失效）
    SkillSelector → 按用户消息关键词评分选择候选 Skill
    SkillTool → 根据 runtime_type 分发到 Sandbox / MCPTool / A2ATool
```

### 6.2 存储结构

每个 Skill 以独立目录存储，目录名为 Skill ID（格式 `{slug}--{sha1[:8]}`）：

```
/app/data/skills/                           # SKILLS_ROOT_DIR（默认 /app/data/skills）
└── <skill_id>/                             # 例如 web-search--a1b2c3d4
    ├── meta.json                           # 元信息（id, slug, name, enabled 等）
    ├── manifest.json                       # 完整 manifest（tools 定义、activation、policy 等）
    ├── SKILL.md                            # Skill 说明文档（含 frontmatter + 正文）
    ├── bundle_index.json                   # bundle 文件索引（path, size, sha256, is_text）
    └── bundle/                             # 打包的源文件目录
        └── ...                             # 实际 skill 源文件
```

### 6.3 领域模型

| 模型 | 说明 |
|------|------|
| `Skill` | 核心领域模型，包含 id / slug / name / source_type / runtime_type / manifest / enabled 等字段 |
| `SkillManifest` | Manifest 结构，包含 tools 列表、activation 条件、policy 策略、security 配置 |
| `SkillManifestTool` | 单个工具声明，包含 name / description / parameters / entry |
| `SkillSourceType` | 来源枚举：`local` / `github`（`mcp_registry` 已废弃） |
| `SkillRuntimeType` | 运行时枚举：`native` / `mcp` / `a2a` |

辅助函数：
- `normalize_skill_slug(raw)` — 规范化 slug（小写 + 非字母数字替换为 `-`）
- `build_skill_key(slug, source_type, source_ref)` — 生成稳定 ID `{slug}--{sha1[:8]}`

### 6.4 应用服务

| 服务 | 职责 |
|------|------|
| `SkillService` | Skill 生命周期管理：安装、启用/禁用、删除；负责 SKILL.md 解析、安全策略检查、context_blob 构建 |
| `SkillSourceLoader` | 从 GitHub tree URL 或本地绝对路径加载 Skill bundle（文件集 + SKILL.md） |
| `SkillSelector` | 基于关键词匹配的渐进式选择器，默认返回 top 12 候选 |
| `SkillIndexService` | 带缓存失效的 Skill 元数据索引，基于目录 mtime 判断是否需要重新加载 |

### 6.5 运行时类型

| 运行时 | 工具调用方式 | 说明 |
|--------|-------------|------|
| `native` | 通过 Sandbox `exec_command` 执行 | 命令格式 `{command} {shlex.quote(json_payload)}`，受 `blocked_command_patterns` 安全限制 |
| `mcp` | 委托 `MCPTool.invoke()` | 转发到 MCP 服务器对应工具 |
| `a2a` | 委托 `A2ATool.call_remote_agent()` | 转发到远程 Agent |

### 6.6 安全机制

- **命令黑名单**：`skill_blocked_command_patterns` 配置项（默认拦截 `rm -rf`、`mkfs.`、`shutdown`、`reboot` 等）
- **风险策略**：`skill_risk_policy.mode`（`off` / `enforce_confirmation`），高风险工具需确认才能执行
- **路径穿越防护**：bundle 文件路径经 `_normalize_bundle_path` 检测 `..` 路径
- **Bundle 限制**：最多 200 文件、单文件 256KB、总量 10MB

### 6.7 API 路由（v2）

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/v2/skills` | 获取 Skill 列表 |
| POST | `/api/v2/skills/install` | 安装 Skill |
| POST | `/api/v2/skills/{skill_key}/enabled` | 更新启用状态 |
| DELETE | `/api/v2/skills/{skill_key}` | 删除 Skill |
| GET | `/api/v2/skills/policy` | 获取风险策略 |
| POST | `/api/v2/skills/policy` | 更新风险策略 |

> 旧版 v1 路由（`/api/app-config/skills/*`）已返回 HTTP 410，引导迁移至 v2。

### 6.8 配置项

| 配置 | 默认值 | 说明 |
|------|--------|------|
| `SKILLS_ROOT_DIR` | `/app/data/skills` | Skill 文件系统存储根目录 |
| `skill_backend` | `filesystem` | 存储后端类型 |
| `skill_blocked_command_patterns` | `rm -rf,:(){,mkfs.,shutdown,reboot` | native Skill 命令黑名单（逗号分隔） |
| `skill_risk_policy.mode` | `off` | 风险策略模式（`off` / `enforce_confirmation`） |
